#!/bin/bash
if echo $SHELLOPTS | grep xtrace; then
    function debug() {
        read -p "press any key to continue..."
    }
else
    function debug() {
        sleep .5
    }
fi

if test $(basename $0) = adb-picture-clean; then
    adb 'for x in /sdcard/DCIM/Camera/toqq-*; do
             if test -e "$x"; then
                 rm -f "$x"
                 am startservice -n com.bhj.setclip/.PutClipService --es picture "$x"
             fi
         done'
    exit
fi
if test "$1"; then
    pic=$1
    if test ! -e "$1" && echo "$1" | grep '://'; then
        ext=${1##*.}
        rm -rf /tmp/$(basename $0).$ext
        curl -o /tmp/$(basename $0).$ext "$1"
        pic=/tmp/$(basename $0).$ext
    fi
else
    pic=$(get-newest-file ~/shots/)
fi
ext=${pic##*.}
adb_pic=/sdcard/DCIM/Camera/toqq-$(now|perl -npe 's/://g').$ext
adb push "$pic" $adb_pic
adb am startservice -n com.bhj.setclip/.PutClipService --es picture $adb_pic

case $(basename $0) in
    adb-picture-to-phone)
        exit
        ;;
    adb-picture-to-weixin-friends)
        adb start-activity com.tencent.mm/com.tencent.mm.plugin.sns.ui.SnsUploadUI
        adb-tap 166 537 # + a picture
        adb-tap 626 278
        adb-tap 909 145
        weixin-new
        ;;
    adb-picture-to-weixin-chat)
        adb-tap-mid-bot # 把输入栏调到中间固定位置，如果已经在固定位置，则只不过多出一个空格来
        debug
        adb-tap 966 999 # 按一下右边的+号，选择图片
        debug
        adb-swipe 125 1285 500 1285 # 右滑一下，微信太他娘的人性化，会把刚扫描出来的那张图片缩略显示出来让你选，取消这个可能的缩略显示☠
        debug
        adb-tap 125 1285 # 按一下选图片按钮
        debug
        debug # 多等一下
        adb-tap 519 417 # 选第一张图片
        debug
        adb-tap 917 1848
        debug
        adb-tap 953 182
        debug
        adb-key BS
        adb-key DEL
        ;;
    adb-picture-to-qq-chat)
        adb-tap-mid-bot
        debug
        adb-tap 151 999 # 点一下加号
        debug
        adb-tap 125 1476 # 点一下图片按钮
        debug
        while ! adb-is-activity com.tencent.mobileqq/com.tencent.mobileqq.activity.photo.AlbumListActivity; do
            adb-tap 118 152 # 点一下相册
            debug
        done
        debug
        adb-tap 457 493 # 点一下第二行，Camera
        debug
        adb-tap 161 423 # 点一下第一张照片
        debug
        adb-tap 917 1848 # 点一下发送
        debug
        adb-key BACK
        adb-key DEL
        ;;
    adb-picture-to-weibo)
        adb start-activity com.sina.weibo/com.sina.weibo.EditActivity
        adb-tap 104 980
        adb-tap 629 290
        adb-tap 923 1850
        weibo
        ;;
esac

adb rm $adb_pic
adb am startservice -n com.bhj.setclip/.PutClipService --es picture $adb_pic
