#!/usr/bin/perl
use String::ShellQuote;

sub eq_hex($)
{
    my ($str) = @_;
    $str =~ s/(.)/"=" . sprintf("%02x", ord($1))/ge;
    return $str;
}

sub debug(@) {
    print STDERR "@_\n";
}

while (<>) {
    chomp;
    @f = split(',');
    if (@f = 1) {
        @f = split(' ');
    }
    debug "name is '$f[0]'";
    my $name = $f[0];
    print "BEGIN:VCARD\nVERSION:2.1\n";
    print "FN;CHARSET=UTF-8;ENCODING=QUOTED-PRINTABLE:" . eq_hex($f[0]) . "\n";
    print "TEL;CELL:$f[1]\n";
    if ($f[2]) {
        print "EMAIL:$f[2]\n";
    }
    my $email = $f[2];
    if ($email =~ m/\@smartisan.com/) {
        my $output_avatar = 0;
      avatar:
        for my $base ($name, $email) {
            for my $ext ("png", "jpg") {
                if (-e "$ENV{HOME}/src/tools/SmartisanPhotos/$base.$ext") {
                    debug "output avatar from $base.$ext";
                    my $img = shell_quote("$base.$ext");
                    system("vcf-generate-jpg ~/src/tools/SmartisanPhotos/$img");
                    $output_avatar = 1;
                    last avatar;
                } else {
                    debug "$ENV{HOME}/src/tools/SmartisanPhotos/$base.$ext" . " is not there, base is $base, ext is $ext";
                }
            }
        }
        if (not $output_avatar) {
            system("cat ~/src/tools/SmartisanPhotos/vcf-default-jpg.snippet");
        }
    }
    print "END:VCARD\n";
}
