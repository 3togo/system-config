#!/bin/bash
sudo apt-get install aptitude
export LANG=C
export LC_ALL=C

packages_dir=${PACKAGES_DIR:-~/bin/Linux/config/pkgs/}
packages=$(find "$packages_dir" -maxdepth 1 -type f|perl -npe 's,.*/,,')
err_packages=""

while ! aptitude show $packages >/dev/null 2>&1; do
    err_packages=$(echo $err_packages; aptitude show $packages 2>&1|grep 'E: Unable to locate package '|perl -npe 'chomp; s/.*E: Unable to locate package//');
    packages=$(arg1-arg2 "$packages" "$err_packages")
done
echo "err_packages are $err_packages" > ~/.logs/$(basename $0).log

missing_packages=$(arg1-arg2 "$packages" "$(aptitude show $packages |perl -ne '
chomp;
if (m/^Package: (.*)$/) {
    $pkg = $1;
    while (<>) {
        chomp;
        if (m/^State: (.*)$|^$/) {
            print $pkg . "\n" if $1 eq "installed";
            last;
        }
    }
}')" | sort -u)

echo "missing_packages are $missing_packages" >> ~/.logs/$(basename $0).log

if test "$(echo "$missing_packages" | wc -l)" -gt 50; then
    if yes-or-no-p -y  "There are too many missing packages, check ~/.logs/$(basename $0).log. Stop?"; then
        exit 1
    else
        true
    fi
fi

if ! ask-if-not-bhj -y "$missing_packages

The above packages are missing, try to install them one by one?"; then
    exit 0
fi

for x in $missing_packages; do
    sudo apt-get install "$@" -y $x || true
done

(
    cd ~/bin/Linux/config/pkgs;
    for x in *:*; do
        test -e "$x" && sudo apt-get install -y "$x" || true
    done
)
