#!/bin/bash

export USE_BUFFER_NAME=send-to-$(basename $0).org
(
    if ! flock -n 9; then
        find-or-exec emacs "No such thing"
        emacsclient -e '(switch-to-buffer "'$USE_BUFFER_NAME'")'
        exit
    fi
    while true; do
        input=$(ask-for-input-with-emacs -p "What do you want say on $(basename $0)?" || true)
        if ! test "$input"; then
            exit
        fi
        (
            flock 10
            putclip-android "$input"&
            if test $(basename $0) = google+; then
                adb-long-press 144 374 # long press
                adb-tap 117 273 # paste
                adb-tap 949 935 # send
            else
                adb-tap 560 1840 #
                sleep .1
                adb-tap 560 1840 # 再点一下，可能在出键盘，需要输入一个空格
                adb-long-press 560 976 # 长点输入框
                adb-tap 525 855 # 点一下粘贴钮
                adb-tap 976 976 # 点一下发送钮
            fi
        ) 10> ~/.logs/$(basename $0).lock-send &
    done
) 9> ~/.logs/$(basename $0).lock
