#!/bin/bash
exec > ~/.logs/of.log 2>&1
set -x

if test $# = 0; then
    set -- "$(xclip -o -selection primary)"
elif test $# = 1; then
    if test -e "$1"; then
        true
    elif test -e "$(lookup-file "$@")"; then
        res=$(lookup-file "$@")
        if test "${res:0:${#PWD}+1}" != "$PWD/" && yes-or-no-p -n "Open $(lookup-file "$@")"; then
            set -- "$(lookup-file "$@")";
        else
            set -- "$(f "$@")"
        fi
    elif ! echo "$@" | grep :// -q && test -e "$(f "$@")"; then
        set -- "$(f "$@")"
    fi
else
    set -- "$(f "$@")"
fi

if test "$EMACS"; then
    setsid=setsid
else
    setsid=
fi

if test $# = 1 && echo "${1}" | grep -q -i -P -e "^https?://"; then
    $setsid firefox -new-tab "$1"
    exit
fi

if test "${1##*.}" = chm; then
    $setsid ffchm "$@"
else
    $setsid xdg-open "$@"
fi
