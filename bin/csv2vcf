#!/usr/bin/perl

sub eq_hex($)
{
    my ($str) = @_;
    $str =~ s/(.)/"=" . sprintf("%02x", ord($1))/ge;
    return $str;
}

sub debug(@) {
    print STDERR "@_\n";
}

while (<>) {
    chomp;
    @f = split(',');
    if (@f = 1) {
        @f = split(' ');
    }
    debug "name is '$f[0]'";
    print "BEGIN:VCARD\nVERSION:2.1\n";
    print "FN;CHARSET=UTF-8;ENCODING=QUOTED-PRINTABLE:" . eq_hex($f[0]) . "\n";
    print "TEL;CELL:$f[1]\n";
    if ($f[2]) {
        print "EMAIL:$f[2]\n";
    }
    my $email = $f[2];
    if ($email =~ m/\@smartisan.com/) {
        if (-e glob("~/src/tools/SmartisanPhotos/$email.jpg")) {
            system("vcf-generate-jpg ~/src/tools/SmartisanPhotos/$email.jpg");
        } else {
            system("cat ~/src/tools/SmartisanPhotos/vcf-default-jpg.snippet");
        }
    }
    print "END:VCARD\n";
}
