#!/bin/bash
if id | grep -q '^uid=0\b' -P; then
    su - bhj -c "~bhj/bin/ask-to-sync-org&"
    exit 0
fi
. ~/.bashrc
(
    id
    ls -l /proc/$$/fd
) > /tmp/$(basename $0).log

function need-sync() {
    if adb 'if test $(stat -c %s /sdcard/MobileOrg/mobileorg.org) != 0; then echo yes; fi' | grep -q yes; then
        return 0
    fi
    return 1
}

if ! is-tty-io; then
    adb -w echo shit
fi
if ! need-sync; then
    exit 0
fi

if ! is-tty-io; then
  xfce4-terminal --maximize -e "bash -c ask-to-sync-org"
  exit 0
fi

set -e
if need-sync; then
    . ~/.config/ssh-agent
    sync-mobile-org
    mkdir -p ~/.cache/sync-mobile-org/
    touch ~/.cache/sync-mobile-org/done
fi
