#!/bin/bash
set -e
if test ! -e "$1"; then
    perl -e '$_ = $ARGV[0];
             if (m!https://login.weibo.cn/login/.*backURL=http%3A%2F%2Fweibo.cn%2F[^%]*%2F([^%&]+)!i) {
                 open_sina($1);
             } elsif (m!http://weibo.(?:com|cn)/[^/]*/([^?/]+)!) {
                 open_sina($1);
             } elsif (m!http://m.weibo.cn/[^/]*/([^/?]*)!) {
                 open_sina($1);
             } elsif (m!https://passport.sina.cn/.*r=http%3A%2F%2Fm.weibo.cn%2F[^%]*%2F([^%&]+)!) {
                 open_sina($1);
             } elsif (m!http://(?:m\\.)?weibo\\.cn/u/([^?/&%]+)!) {
                 open_sina_user($1);
             } else {
                 system("my-adb", "am", "start", $_);
             }
             sub open_sina($) {
                 system("my-adb", "am", "start", "sinaweibo://detail?mblogid=$_[0]");
             }
         ' "$1"
    exit
fi
ext=${1##*.}
if test "$ext" = mp3; then
    out=/sdcard/Music/"$(basename "$1")"
else
    out=/sdcard/adb-of.$ext
fi
my-adb push "$1" "$out"
adb-scan-media "$out"
my-adb am start file://"$out"
