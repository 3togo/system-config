#!/bin/bash

set -e
function die() {
    echo Error: "$@"
    exit -1
}

smb_host=$(echo "$1" | perl -ne 'if (m!//(.*?)/!) {print $1}')
if test ! "$smb_host"; then
    die "Can't decide the smb host; usage: $(basename $0) //share.smartisan.cn/share/"
fi

user_pass=$(
    if grep -q -P "^auth\s+$smb_host\s+" ~/.smb/smbnetfs.conf; then
        grep -P "^auth\s+$smb_host\s+" ~/.smb/smbnetfs.conf;
    else
        grep -P "^auth\s+\S+\s+\S+\s*$" ~/.smb/smbnetfs.conf;
    fi | perl -ne 'if (m/\s+(\S+)\s+(\S+)\s*$/) {print "$1%$2"}')

smbclient -U "$user_pass" "$@"
