#!/bin/bash

set -e

function die() {
    echo Error: "$@"
    find-or-exec konsole
    exit -1
}

find-or-exec emacs emacs.bhj
while ! emacsclient -e '(save-some-buffers)'; do
    sleep 1
    echo "Emacs need save some buffers"
done

find-or-exec konsole
cd ~/doc/projects

if git-dirty; then
    git-interactive-add
    git commit -m 'auto commit' -s
fi

if test ! -d ~/today/MobileOrg; then
    rm -rf ~/today/forever/MobileOrg;
    mkdir -p ~/today/forever/MobileOrg;
    download-today
    cd -P ~/today/MobileOrg;

    for x in $(adb ls /sdcard/MobileOrg/); do
        adb pull /sdcard/MobileOrg/$(basename $x) .
    done

    git init
    git add .
    git commit -m 'Init version'
fi

cd ~/today/MobileOrg/
if test ! -d .git; then
    git init
fi
if git-dirty; then
    git-interactive-add
fi

yes-or-no-p -y "Sync MobileOrg APP on you phone manually done"


for x in $(adb ls /sdcard/MobileOrg/); do
    if test $x = from-mobile.org; then
        continue
    fi
    adb pull /sdcard/MobileOrg/$(basename $x) .
done

find-or-exec emacs emacs.bhj
emacsclient -e '(org-mobile-pull)'

emacsclient -e '(save-some-buffers)'

function check_git_dir() {
    if test $# != 2; then
        die "Error: Usage $(basename $0) dir prompt"
    fi

    cd  "$1"

    find-or-exec konsole
    git-interactive-add
    if ! yes-or-no-p -y "Continue for $2 @$PWD"; then
        exit 0
    fi
}

check_git_dir ~/doc/projects "Add all changes from mobile to Emacs"
emacsclient -e '(org-mobile-push)'

if (cd ~/doc/projects && git diff HEAD . | grep -v -e '^\+\s+:(properties|id|end):' -i -P | grep '^(-|\+) ' -P ); then
    check_git_dir ~/doc/projects "Add all changes after org-mobile-push?"
else
    (cd ~/doc/projects && git add .)
fi

cd ~/today/MobileOrg
git add agendas.org checksums.dat
check_git_dir ~/today/MobileOrg "Add all changes after org-mobile-push?"

for x in *; do
    adb push $x /sdcard/MobileOrg/$x
done

yes-or-no-p -y "Sync MobileOrg APP on you phone manually done"
