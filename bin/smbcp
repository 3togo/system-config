#!/bin/bash

export SHELLOPTS
function die() {
    echo Error: "$@"
    exit -1
}

if test $# -lt 2; then
    die "Error: Usage $(basename $0) source target"
fi

set -e
if test $# = 2 -a ! -d "$2"; then
    if test $(basename $0) = smbcp; then
        mkdir -p "$2"
    fi
fi

if test $# -gt 2; then
    save_arg=$1
    shift
    echo doing "$@"
    $(basename $0) "$@"
    while test $# -gt 1; do
        shift
    done
    echo "doing $save_arg"
    $(basename $0) "$save_arg" "$@"
    exit
fi

if test $(basename $0) = smbcp; then
    src=$(readlink -f "$1")
else

    set -- "$(readlink -f "$1")" "$(readlink -m "$2")"
    if test -d "$2"; then
        set -- "$1" "$2/$(basename "$1")"
    fi
    base_dest=$(basename "$2")
    src=$(readlink -f "$2")
fi
smb=$(readlink -f ~/smb)

if test "${src:0:${#smb}}"/ != "$smb/"; then
    die "must run this command in ~/smb"
fi


base_src=$(basename "$src")
share=/${src:${#smb}}
D=$share
share=$(echo "$share" |perl -npe 's!^(//([^/]+/){2}).*!$1!')
D=${D:${#share}}
D=$(dirname "$D")
smb_host=${share#//}
smb_host=${smb_host%%/*}

user_pass=$(
    if grep -q -P "^auth\s+$smb_host\s+" ~/.smb/smbnetfs.conf; then
        grep -P "^auth\s+$smb_host\s+" ~/.smb/smbnetfs.conf;
    else
        grep -P "^auth\s+\S+\s+\S+\s*$" ~/.smb/smbnetfs.conf;
    fi | perl -ne 'if (m/\s+(\S+)\s+(\S+)\s*$/) {print "$1%$2"}')



if test $(basename $0) = smbcp; then
    smbclient "$share" -D "$D" -U "$user_pass" -c "tarmode; recurse; prompt; lcd $2; mget \"$base_src\""
else
    smbclient "$share" -D "$D" -U "$user_pass" -c "tarmode; recurse; prompt; put \"$1\" \"$base_dest\""
fi
