#!/bin/bash
if echo $SHELLOPTS | grep xtrace; then
    function debug() {
        read -p "press any key to continue..."
    }
else
    function debug() {
        sleep .5
    }
fi

if (
    test "$(basename $0)" = adb-call || test "$(basename $0)" = adb-sms-to
) && ! echo "$1" | grep -q -P -e '^\d+$'; then
    true
else
    putclip-android "$1"
fi
debug
if test "$(basename $0)" = adb-weixin-choose-chatter; then
    adb am start -n com.tencent.mm/.ui.LauncherUI
    sleep .5
    adb-tap 141 178 adb-tap-2 141 178
    for x in $(seq 1 10); do
        adb-tap 642 144
        if adb-is-activity com.tencent.mm/com.tencent.mm.plugin.search.ui.SearchContactUI; then
            break
        fi
        sleep .5
    done
    adb-long-press 375 137
    adb-tap 275 405
    adb-tap 248 474
elif test "$(basename $0)" = adb-call -o "$(basename $0)" = adb-sms-to; then
    if ! echo "$1" | grep -q -P -e '^\d+$'; then
        who=$1
        set -x
        shift
        number=$(select-output-line 'bbdb '"$who"'|perl -npe "s/\\\\n/\\n/g"' | grep -o -P '\d+$')
        if test "$number"; then
            echo "using $number" "$@"
            set -- "$number" "$@"
        fi
    fi

    if test "$(basename $0)" = adb-call; then
        adb am start -n com.android.contacts/.activities.DialtactsActivity >/dev/null 2>&1 &
        sleep .5

        if echo "$1" | grep -q -P -e '^\+?\d+$'; then
            adb-tap-2 614 1829
            adb-long-press 898 1689 .8
            # sendtext-android "$1"
            putclip-android "$1"
            adb-long-press 646 174
            adb-tap 559 452
            adb-tap 479 1640
            exit
        fi

        adb-tap-2 332 1879
        adb-tap 132 260
        adb-long-press 183 146
        adb-tap 72 403
        adb-tap 253 270
        adb-tap 637 665
    elif test "$(basename $0)" = adb-sms-to; then
        adb start-activity com.android.mms/.ui.ConversationList
        if adb-is-activity com.android.mms/com.android.mms.ui.ComposeMessageActivity; then
            adb-key BACK
        fi
        adb-tap 958 149
        sendtext-android "$1"
        shift
        weixin "$@"
    fi
elif test "$(basename $0)" = adb-qq-choose-chatter; then
    adb am start -n com.tencent.mobileqq/.activity.SplashActivity
    debug
    while true; do
        window=$(adb-focused-window)
        if echo $window|grep -q SplashActivity; then
            break
        elif test "$window" = com.smartisanos.launcher/com.smartisanos.launcher.Launcher; then
            exet adb-qq-choose-chatter "$@"
        else
            adb-key BACK
        fi
    done
    adb-tap-mid-bot
    adb-tap 433 284
    sleep .2
    adb-long-press 190 149
    adb-tap 79 391
    debug
    adb-tap 287 272
    debug
    if adb-is-activity com.tencent.mobileqq/com.tencent.mobileqq.activity.FriendProfileCardActivity; then
        adb-tap 816 1830
    fi
fi
